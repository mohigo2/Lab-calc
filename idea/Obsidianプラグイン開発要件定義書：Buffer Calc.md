### 1. 概要と目的

**Obsidianのノート上で**、研究室でのバッファー調製における一連の計算作業をシームレスに実行・記録するためのプラグインを開発します。手計算による時間的コストと計算ミスを削減し、**Obsidianを研究ノートとして活用する上での**効率性、正確性、再現性の向上に貢献します。

---

### 2. 実装方式の提案

ユーザーの利便性を考慮し、以下の2つの実装方式を提案します。コアとなる計算機能は共通化し、両方の方法でアクセスできるようにするのが理想的です。

* **A) コードブロック方式（推奨）**:
    ノート内に専用のコードブロック（例: ` ```buffer ``` `）を記述すると、そのブロックがプレビューモードでインタラクティブな計算機UIに変換される方式。計算過程と結果をノートに直接埋め込めるため、記録性に優れています。
* **B) コマンドパレット/モーダル方式**:
    コマンドパレット (`Cmd/Ctrl+P`) から「バッファー調製計算」コマンドを実行すると、計算用のモーダルウィンドウ（ポップアップ画面）が表示される方式。素早く計算したい場合に適しています。

---

### 3. コア計算機能

プラグインの中核をなす計算機能です。

#### 3.1. 多成分バッファー調製計算
* **機能**: 複数の原液から目的のバッファーを調製する際の各原液の必要量と、メスアップする溶媒量を計算します。
* **入力**: 最終容量、各試薬の原液濃度・最終濃度。
* **出力**: 各試薬の必要量、溶媒の追加量。

#### 3.2. 粉末からのストック溶液計算
* **機能**: 粉末試薬を溶かして特定の濃度のストック溶液を作成する際に、必要な粉末の重量を計算します。
* **入力**: 分子量(FW)、目標濃度、作成量。
* **出力**: 必要な粉末重量。

#### 3.3. 連続希釈計算
* **機能**: ストック溶液 → 中間希釈液 → ワーキング溶液といった、段階的な希釈計算に対応します。

---

### 4. 生産性・正確性向上機能

計算作業を効率化し、ミスを減らすための支援機能です。

#### 4.1. 試薬データベース
* **機能**: よく使う試薬の分子量(FW)を内蔵し、試薬名入力時に自動補完します。ユーザーによるカスタム試薬の登録・編集も可能です。

#### 4.2. レシピ管理（保存・共有）
* **保存**: 計算したバッファー組成を名前を付けて保存します。データはVault内のJSONファイルに記録され、Obsidian Sync等で同期可能です。
* **呼び出し**: 保存したレシピをリストから選択し、計算フォームに自動入力します。
* **共有**: レシピをMarkdownテーブル形式でノートに挿入したり、QRコードで他者と共有したりできます。

#### 4.3. ロット番号の記録
* **機能**: 再現性確保のため、使用した試薬のロット番号を記録する入力欄を設けます。この情報は計算結果と共にノートに出力可能です。

#### 4.4. エラー＆警告表示
* **機能**: 原液より最終濃度が高い場合など、論理的に誤った入力に対してリアルタイムで警告を表示し、ミスを未然に防ぎます。

#### 4.5. 試薬情報への外部リンク
* **機能**: 試薬名からPubChemや試薬メーカーの製品ページへ直接飛べるリンクを自動生成し、SDS等の確認を容易にします。

---

### 5. UI/UX要件

直感的で快適な操作性を提供するための要件です。

#### 5.1. 動的な試薬追加・削除
* **機能**: 「＋」ボタンで試薬の入力欄を自由に増減でき、2成分から多成分系まで柔軟に対応します。

#### 5.2. 単位の自動最適化表示
* **機能**: `0.0015 L` のような計算結果を、`1.5 mL` や `1500 µL` といったピペッティングに適した単位へ自動変換して表示します。

---

### 6. UI/UXデザインの参考 🎨

優れたUI/UXを実現するため、以下の既存プラグインをデザインの参考とします。UI部品やデザイン思想を参考にし、**コードブロックの表示領域に最適化されたレイアウトで再構築**します。

* **Projects**:
    * **参考ポイント**: 洗練されたデータテーブル表示、複雑な入力フォーム。
    * **活用箇所**: 「レシピ一覧」機能の表示や、データ編集画面の設計。
* **Style Settings**:
    * **参考ポイント**: スライダーやドロップダウンといった、直感的な設定部品。
    * **活用箇所**: プラグイン設定画面や、計算UI内の各種入力コンポーネント。
* **Kanban**:
    * **参考ポイント**: シンプルで分かりやすいモーダルウィンドウ（ポップアップ画面）。
    * **活用箇所**: 新規の試薬やレシピを追加する際の入力フォーム。

---

### 7. Obsidian連携要件

Obsidianのエコシステムに深く統合するための要件です。

#### 7.1. コマンドパレット統合
* **機能**: `Cmd/Ctrl+P` から「新規バッファー計算」や「レシピを挿入」といったコマンドを直接実行できます。

#### 7.2. 設定タブの追加
* **機能**: Obsidianの設定画面に本プラグイン専用の項目を追加し、各種カスタマイズ（デフォルト単位など）を可能にします。

#### 7.3. DataView連携
* **機能**: レシピを個別のMarkdownファイルとして保存するオプションを提供します。これにより、Obsidianの強力なプラグイン `DataView` を用いて、ノート内でレシピ一覧を動的に生成・管理できます。

---

### 8. オプション機能・将来的な拡張案

* **コスト計算機能**: 試薬の価格情報を基に、調製するバッファーのおおよそのコストを算出する機能。

---

### 9. 開発・技術要件

* **使用言語**: TypeScript
* **UIフレームワーク**: Svelte または React の使用を推奨
* **開発の基盤**: **`Numerals`** プラグインのコードブロック処理の仕組みを参考に開発を開始する。
* **Obsidian APIの利用**: `registerMarkdownCodeBlockProcessor`, `Modal`, `PluginSettingTab`, `adapter` 等を適切に利用します。

---

### 10. 非機能要件

* **パフォーマンス**: Obsidianの起動や動作に影響を与えない軽量な実装。
* **データ安全性**: ユーザーデータは全てユーザー自身のVault内にのみ保存。
* **互換性**: デスクトップ版およびモバイル版での基本動作を確保。